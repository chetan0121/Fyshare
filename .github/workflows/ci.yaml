name: CI - Python Compatibility

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version:
          - "3.8"     # Explicitly test the oldest supported
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"    # Will use 3.13.x when available

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Display Python and package info
        run: |
          python --version
          pip list

      - name: Run FyShare.py (full compatibility smoke test)
        timeout-minutes: 3
        run: |
          # Start the app in background
          python FyShare.py &
          APP_PID=$!

          # Wait a moment for startup
          sleep 10

          # Simple health check: look for common startup success message
          # Adjust this line if your app logs something specific like "Server running on http://0.0.0.0:5000"
          if ps -p $APP_PID > /dev/null; then
            echo "FyShare.py is still running â†’ basic startup test passed"
          else
            echo "FyShare.py crashed on startup!"
            exit 1
          fi

          # Gracefully stop the app
          kill $APP_PID || true
          wait $APP_PID || true

      - name: Run with timeout fallback (if app doesn't exit cleanly)
        if: failure()
        run: |
          echo "Previous step failed, force-killing any remaining Python processes"
          pkill -f FyShare.py || true
