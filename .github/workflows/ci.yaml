name: CI - Python Compatibility

# Trigger on pushes or PRs to main + dev
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      # Test against multiple Python versions
      matrix:
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"   # will resolve to next available prerelease automatically

    steps:

      # Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install chosen Python version
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true  # enables Python 3.13 testing

      # Install Python dependencies if present
      - name: Install dependencies (if exists)
        run: |
          if [ -f requirements.txt ]; then
            echo "Installing from requirements.txt"
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping installation"
          fi

      # Show Python context for debugging
      - name: Display Python and installed packages
        run: |
          python --version
          pip list

      # Smoke test startup: ensure the app does not crash on import/start
      - name: Run FyShare.py (startup smoke test)
        id: smoke
        env:
          FYSHARE_CI: "1"  # Flag for python code
        run: |
          set +e   # Prevent job crash on failure, we will handle manually

          # Start the app in background
          python FyShare.py &
          APP_PID=$!

          # Allow some time for startup (not too long)
          sleep 10

          # Check if running after delay
          if ps -p $APP_PID > /dev/null; then
            echo "passed=true" >> "$GITHUB_OUTPUT"
            echo "FyShare.py OK: running after 10s"
          else
            echo "passed=false" >> "$GITHUB_OUTPUT"
            echo "FyShare.py FAILED: crashed during startup!"
          fi

          # Shutdown
          kill $APP_PID 2>/dev/null || true
          wait $APP_PID 2>/dev/null || true

      # Cleanup & fail the job if smoke test failed
      - name: Force cleanup and mark failure
        if: steps.smoke.outputs.passed == 'false'
        run: |
          echo "Force-killing any remaining FyShare.py processes..."
          pkill -f FyShare.py || true
          echo "CI FAILED: FyShare.py startup crash"
          exit 1
